<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horaires UQAM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9; /* Light grey background */
        }
        .top-bar {
            background-color: #007bff; /* Bootstrap primary blue */
            color: white;
            padding: 10px 15px;
            text-align: center;
        }
        .container {
            padding: 20px;
            margin-top: 10px;
        }
        .form-section, .class-list-section, .calendar {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dee2e6; /* Light grey border */
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #e9ecef; /* Light grey header */
        }
        .class-info {
            cursor: help; /* Changes the cursor to indicate that these can be interacted with */
            background-color: #eef; /* Light blue background to distinguish these cells */
        }
        .sigle-container span.badge {
            margin-right: 5px;
            display: inline-block;
            padding: 10px;
        }
        .class-list {
            list-style-type: none;
            padding: 0;
        }
        .class-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .class-list li .remove-btn {
            background-color: transparent;
            border: none;
            color: red;
            cursor: pointer;
        }
        @media (min-width: 768px) {
            .container {
                display: flex;
                justify-content: space-around;
            }
            .calendar {
                flex: 3;
                margin-left: 20px; /* Space between the calendar and form */
            }
            .form-section, .class-list-section {
                flex: 1;
            }
            .mobile-view {
                display: none;
            }
        }
        @media (max-width: 767px) {
            .desktop-view {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <strong>ZicoCorp: Horaires UQAM 1.0</strong>
    </div>
    <div class="container">
        <div class="form-section">
            <h2>Cours</h2>
            <form id="scheduleForm" action="/schedule" method="post">
                <div class="mb-3">
                    <label for="sigles" class="form-label">Sigles (séparés par virgule):</label>
                    <input type="text" id="sigles" name="sigles" class="form-control" placeholder="INF1120,AOT1110">
                </div>
                <fieldset class="mb-3">
                    <legend>Session:</legend>
                    <div class="form-check">
                        <input type="radio" id="winter2024" name="season" value="winter2024" class="form-check-input">
                        <label for="winter2024" class="form-check-label">Hiver 2024</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="summer" name="season" value="summer" class="form-check-input">
                        <label for="summer" class="form-check-label">Été 2024</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="fall" name="season" value="fall" class="form-check-input" checked>
                        <label for="fall" class="form-check-label">Autonme 2024</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="winter" name="season" value="winter" class="form-check-input">
                        <label for="winter" class="form-check-label">Hiver 2025</label>
                    </div>
                </fieldset>
                <button type="submit" class="btn btn-primary">Génerer</button>
            </form>
        </div>
        <div class="class-list-section">
            <h2>Liste des Cours</h2>
            <div class="sigle-container mt-3">
                <ul id="classList" class="class-list"></ul>
            </div>
        </div>
        <div class="calendar">
            <h2>Calendrier</h2>
            <div class="nav-buttons mb-3">
                <button id="prevSchedule" class="btn btn-secondary">&larr; Précedent</button>
                <span id="scheduleIndex">1/1</span>
                <button id="nextSchedule" class="btn btn-secondary">Suivant &rarr;</button>
            </div>
            <div id="calendarContent" class="mobile-view"></div>
            <table id="calendarTable" class="table desktop-view">
                <thead>
                    <tr>
                        <th>Heure</th>
                        <th>Lundi</th>
                        <th>Mardi</th>
                        <th>Mercredi</th>
                        <th>Jeudi</th>
                        <th>Vendredi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Calendar rows will be inserted dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    <div class="blur-mask" id="blurMask">
        <div class="spinner"></div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const calendarTableBody = document.querySelector('#calendarTable tbody');
        const calendarContent = document.getElementById('calendarContent');
        const blurMask = document.getElementById('blurMask');

        function displayCalendar(schedule) {
            calendarContent.innerHTML = ''; // Clear previous content
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];

            days.forEach((day, dayIndex) => {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('day-column');
                dayDiv.innerHTML = `<h3>${day}</h3>`;

                for (let hour = 8; hour < 22; hour++) {
                    for (let half = 0; half < 2; half++) {
                        const timeSlot = document.createElement('div');
                        timeSlot.classList.add('time-slot');
                        const minutes = half === 0 ? "00" : "30";
                        timeSlot.textContent = `${hour}:${minutes}`;

                        // Check if there's a class in this time slot
                        const classDetail = schedule.find(classItem => {
                            return classItem.day === day &&
                                classItem.start_time === `${hour}h${minutes}`;
                        });

                        if (classDetail) {
                            timeSlot.textContent += ` - ${classDetail.name} - Groupe ${classDetail.group}`;
                            timeSlot.title = `Cours: ${classDetail.name}\nEnseignant: ${classDetail.teacher}\nHeure: ${classDetail.start_time} - ${classDetail.end_time}\nLocal: ${classDetail.location}`;
                            timeSlot.classList.add('class-info');
                        }

                        dayDiv.appendChild(timeSlot);
                    }
                }
                calendarContent.appendChild(dayDiv);
            });
        }

        document.getElementById('scheduleForm').addEventListener('submit', function(event) {
            event.preventDefault();
            blurMask.classList.add('active');
            const formData = new FormData(event.target);
            const sigles = formData.get('sigles').split(',').map(s => s.trim()).filter(s => s);
            displayClassList(sigles);

            fetch('/schedule', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.schedules) {
                    window.schedules = data.schedules;
                    window.currentScheduleIndex = 0;
                    updateScheduleDisplay();
                    fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                        blurMask.classList.remove('active');
                    });
                } else {
                    blurMask.classList.remove('active');
                    console.error('No schedules returned:', data);
                }
            })
            .catch(error => {
                blurMask.classList.remove('active');
                console.error('Error fetching schedules:', error);
            });

            // Clear the input form after submission
            //event.target.reset();
        });

        document.getElementById('prevSchedule').addEventListener('click', function() {
            blurMask.classList.add('active');
            if (window.currentScheduleIndex > 0) {
                window.currentScheduleIndex--;
                updateScheduleDisplay();
                fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                    blurMask.classList.remove('active');
                });
            } else {
                blurMask.classList.remove('active');
            }
        });

        document.getElementById('nextSchedule').addEventListener('click', function() {
            blurMask.classList.add('active');
            if (window.currentScheduleIndex < window.schedules.length - 1) {
                window.currentScheduleIndex++;
                updateScheduleDisplay();
                fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                    blurMask.classList.remove('active');
                });
            } else {
                blurMask.classList.remove('active');
            }
        });

        function displayClassList(classes) {
            const classList = document.getElementById('classList');
            classList.innerHTML = ''; // Clear previous list
            const siglesInput = document.getElementById('sigles'); // Get the input field

            classes.forEach((className, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = className;
                const removeButton = document.createElement('button');
                removeButton.textContent = 'X';
                removeButton.className = 'remove-btn';
                removeButton.onclick = function() {
                    blurMask.classList.add('active'); // Show the blur mask
                    classes.splice(index, 1); // Remove class from array
                    displayClassList(classes); // Update display
                    siglesInput.value = classes.join(','); // Update the input field with remaining classes

                    // Create a FormData object and submit the updated list
                    const formData = new FormData(document.getElementById('scheduleForm'));
                    formData.set('sigles', classes.join(',')); // Update the formData sigles field
                    fetch('/schedule', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.schedules) {
                            window.schedules = data.schedules;
                            window.currentScheduleIndex = 0;
                            updateScheduleDisplay();
                            fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                                blurMask.classList.remove('active');
                            });
                        } else {
                            blurMask.classList.remove('active');
                            console.error('No schedules returned:', data);
                        }
                    })
                    .catch(error => {
                        blurMask.classList.remove('active');
                        console.error('Error fetching schedules:', error);
                    });
                };
                listItem.appendChild(removeButton);
                classList.appendChild(listItem);
            });
        }

        function updateScheduleDisplay() {
            document.getElementById('scheduleIndex').textContent = `${window.currentScheduleIndex + 1}/${window.schedules.length}`;
        }

        function fetchAndDisplaySchedule(index) {
            const schedule = window.schedules[index];
            return Promise.all(schedule.map(className => fetch(`/class_details?class_name=${className}`)
                .then(res => res.json())
                .then(res => res.class_details)))
            .then(classDetailsArray => {
                displaySchedule(classDetailsArray.flat());
            })
            .catch(error => {
                console.error('Error fetching class details:', error);
            });
        }

        function displaySchedule(classes) {
            const calendarTableBody = document.querySelector('#calendarTable tbody');
            calendarTableBody.innerHTML = '';

            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
            days.forEach(day => {
                const dayColumn = document.createElement('div');
                dayColumn.classList.add('day-column');
                dayColumn.innerHTML = `<h3>${day}</h3>`;
                calendarContent.appendChild(dayColumn);

                const timeSlots = [];
                for (let hour = 8; hour < 22; hour++) {
                    for (let half = 0; half < 2; half++) {
                        const timeSlot = document.createElement('div');
                        const minutes = half === 0 ? "00" : "30";
                        timeSlot.classList.add('time-slot');
                        timeSlot.textContent = `${hour}:${minutes}`;
                        timeSlots.push(timeSlot);
                    }
                }

                timeSlots.forEach(timeSlot => {
                    dayColumn.appendChild(timeSlot);
                });

                classes.forEach(classDetail => {
                    if (classDetail.day === day) {
                        const startHour = parseInt(classDetail.start_time.split('h')[0]);
                        const startMinute = parseInt(classDetail.start_time.split('h')[1] || "00");
                        const endHour = parseInt(classDetail.end_time.split('h')[0]);
                        const endMinute = parseInt(classDetail.end_time.split('h')[1] || "00");

                        const startIndex = (startHour - 8) * 2 + (startMinute >= 30 ? 1 : 0);
                        const endIndex = (endHour - 8) * 2 + (endMinute > 0 ? 1 : 0);

                        for (let i = startIndex; i < endIndex; i++) {
                            if (timeSlots[i]) {
                                timeSlots[i].textContent += ` - ${classDetail.name} - Groupe ${classDetail.group}`;
                                timeSlots[i].title = `Cours: ${classDetail.name}\nEnseignant: ${classDetail.teacher}\nHeure: ${classDetail.start_time} - ${classDetail.end_time}\nLocal: ${classDetail.location}`;
                                timeSlots[i].classList.add('class-info');
                            }
                        }
                    }
                });
            });
        }
      });
    </script>
</body>
</html>
