<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-FT7B8S689B"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FT7B8S689B');
        </script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Horaires UQAM</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        transform: scale(0.80);
        height: 100%;
        margin: 0;
        padding: 0;
        width: 125%;
        height: 125%;
        transform-origin: top left;
    }

    .top-bar {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        text-align: center;
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        padding: 20px;
        margin-top: 10px;
    }

    .calendar {
        flex: 3;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .form-section {
        flex: 1;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        margin-left: 20px;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid #dee2e6;
    }

    th, td {
        border: 1px solid #dee2e6;
        padding: 8px;
        text-align: center;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }

    th {
        background-color: #e9ecef;
        border-top: none;
    }

    tr:last-child td {
        border-bottom: none;
    }

    td:last-child, th:last-child {
        border-right: none;
    }

    .class-info {
        cursor: help;
        background-color: #eef;
    }

    .sigle-container span.badge {
        margin-right: 5px;
        display: inline-block;
        padding: 10px;
    }

    .class-list {
        list-style-type: none;
        padding: 0;
    }

    .class-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .class-list li .remove-btn {
        background-color: transparent;
        border: none;
        color: red;
        cursor: pointer;
    }

    .blur-mask {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.5s;
    }

    .blur-mask.active {
        visibility: visible;
        opacity: 1;
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #000;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }

        .form-section {
            order: -1;
            margin-left: 0;
        }

        .calendar {
            order: 1;
            margin-left: 0;
        }
    }
</style>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    </head>
    <body>
        <div class="top-bar">
            <strong>ZicoCorp: Horaires UQAM 1.0</strong>
        </div>
        <div class="container">
            <div class="calendar">
                <h2>Calendrier</h2>
                <div class="nav-buttons mb-3">
                    <button id="prevSchedule" class="btn btn-secondary">&larr; Précedent</button>
                    <span id="scheduleIndex">1/1</span>
                    <button id="nextSchedule" class="btn btn-secondary">Suivant &rarr;</button>
                </div>
                <table id="calendarTable" class="table">
                    <thead>
                        <tr>
                            <th>Heure</th>
                            <th>Lundi</th>
                            <th>Mardi</th>
                            <th>Mercredi</th>
                            <th>Jeudi</th>
                            <th>Vendredi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Calendar rows will be inserted dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="form-section">
                <h2>Cours</h2>
                <form id="scheduleForm" action="/schedule" method="post">
                    <div class="mb-3">
                        <label for="sigles" class="form-label">Sigles (séparés par virgule):</label>
                        <input type="text" id="sigles" name="sigles" class="form-control" placeholder="ex.: INF1120,INF1132" style="text-transform:uppercase">
                    </div>
                    <div class="mb-3 d-none">
                        <label for="min_length" class="form-label">Nombre de cours minimum sur l'horaire:</label>
                        <input type="number" id="min_length" name="min_length" class="form-control" min=0>
                    </div>
                    <fieldset class="mb-3">
                        <legend>Session:</legend>
                        <div class="form-check">
                            <input type="radio" id="winter2024" name="season" value="winter2024" class="form-check-input">
                            <label for="winter2024" class="form-check-label">Hiver 2024</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" id="summer" name="season" value="summer" class="form-check-input">
                            <label for="summer" class="form-check-label">Été 2024</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" id="fall" name="season" value="fall" class="form-check-input" checked>
                            <label for="fall" class="form-check-label">Automne 2024</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" id="winter" name="season" value="winter" class="form-check-input">
                            <label for="winter" class="form-check-label">Hiver 2025</label>
                        </div>
                    </fieldset>
                    <button type="submit" class="btn btn-primary">Génerer</button>
                </form>
                <div class="sigle-container mt-3">
                    <ul id="classList" class="class-list"></ul>
                </div>
            </div>
        </div>
        <div class="blur-mask" id="blurMask">
            <div class="spinner"></div>
        </div>
        <script>
            let classNames = [];
            $(document).ready(function() {
                $.getJSON('/static/cours_uqam.json', function(data) {
                    classNames = data;
                });
                const maxSuggestions = 10;
                $('#sigles').autocomplete({
                    source: function(request, response) {
                        // Split the request term by commas and trim the spaces
                        const terms = request.term.split(',').map(term => term.trim());
                        // Get the last term to autocomplete
                        const lastTerm = terms[terms.length - 1].toUpperCase();
                        const matches = $.grep(classNames, function(className) {
                            return className.startsWith(lastTerm);
                        }).slice(0, maxSuggestions); // Limit the number of suggestions to maxSuggestions
                        response(matches);
                    },
                    minLength: function() {
                        const value = $('#sigles').val();
                        // Calculate minLength based on field content length minus the number of commas
                        const commaCount = (value.match(/,/g) || []).length;
                        return 2 + value.length - commaCount;
                    },
                    focus: function() {
                        // Prevent value inserted on focus
                        return false;
                    },
                    select: function(event, ui) {
                        const terms = this.value.split(',').map(term => term.trim());
                        // Remove the current input
                        terms.pop();
                        // Add the selected item
                        terms.push(ui.item.value);
                        // Update the input with the new terms without adding a comma or space
                        this.value = terms.join(',');
                        return false;
                    }
                });
                // Trigger the autocomplete when typing
                $('#sigles').on('input', function() {
                    $(this).autocomplete("search");
                });
            });
        </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        clearCalendar();

        document.getElementById('scheduleForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const sigles = formData.get('sigles').split(',').map(s => s.trim()).filter(s => s);
            if (sigles.length == 0) {
                return;
            }
            blurMask.classList.add('active');
            displayClassList(sigles);
            fetch('/schedule', {
                method: 'POST',
                body: formData
            }).then(response => response.json()).then(data => {
                if (data && data.schedules) {
                    window.schedules = data.schedules;
                    window.currentScheduleIndex = 0;
                    updateScheduleDisplay();
                    fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                        blurMask.classList.remove('active');
                    });
                } else {
                    blurMask.classList.remove('active');
                    console.error('No schedules returned:', data);
                }
            }).catch(error => {
                blurMask.classList.remove('active');
                alert("Aucun horaire n'a été trouvé!")
                clearCalendar()
                console.error('Error fetching schedules:', error);
            });
        });

        document.getElementById('prevSchedule').addEventListener('click', function() {
            blurMask.classList.add('active');
            if (window.currentScheduleIndex > 0) {
                window.currentScheduleIndex--;
                updateScheduleDisplay();
                fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                    blurMask.classList.remove('active');
                });
            } else {
                blurMask.classList.remove('active');
            }
        });

        document.getElementById('nextSchedule').addEventListener('click', function() {
            blurMask.classList.add('active');
            if (window.currentScheduleIndex < window.schedules.length - 1) {
                window.currentScheduleIndex++;
                updateScheduleDisplay();
                fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                    blurMask.classList.remove('active');
                });
            } else {
                blurMask.classList.remove('active');
            }
        });

        function clearCalendar() {
            const calendarTableBody = document.querySelector('#calendarTable tbody');
            calendarTableBody.innerHTML = '';
            const startHour = 9; // Start at 9:00 AM
            const endHour = 22; // End at 10:00 PM
            const rows = (endHour - startHour) * 2; // Two rows per hour
            const columns = 6; // 6 columns (Time + Weekdays)
            let currentHour = startHour;
            for (let i = 0; i < rows; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < columns; j++) {
                    const cell = document.createElement('td');
                    if (j === 0) { // First column: Time column
                        const time = `${currentHour.toString().padStart(2, '0')}:${i % 2 === 0 ? '00' : '30'}`;
                        cell.textContent = time;
                        if (i % 2 === 1) { // Increment the hour every two iterations (every full hour)
                            currentHour++;
                        }
                    }
                    row.appendChild(cell);
                }
                calendarTableBody.appendChild(row);
            }
            window.schedules = [];
            window.currentScheduleIndex = 0;
            document.getElementById("scheduleIndex").innerHTML = "1/1";
        }

        function displayClassList(classes) {
            const classList = document.getElementById('classList');
            classList.innerHTML = '';
            const siglesInput = document.getElementById('sigles');
            classes.forEach((className, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = className.toUpperCase();
                const removeButton = document.createElement('button');
                removeButton.textContent = 'X';
                removeButton.className = 'remove-btn';
                removeButton.onclick = function() {
                    blurMask.classList.add('active');
                    classes.splice(index, 1);
                    displayClassList(classes);
                    siglesInput.value = classes.join(',');
                    const formData = new FormData(document.getElementById('scheduleForm'));
                    formData.set('sigles', classes.join(','));
                    if (classes.length == 0) {
                        clearCalendar();
                        blurMask.classList.remove('active');
                        return;
                    }
                    fetch('/schedule', {
                        method: 'POST',
                        body: formData
                    }).then(response => response.json()).then(data => {
                        if (data && data.schedules) {
                            window.schedules = data.schedules;
                            window.currentScheduleIndex = 0;
                            updateScheduleDisplay();
                            fetchAndDisplaySchedule(window.currentScheduleIndex).finally(() => {
                                blurMask.classList.remove('active');
                            });
                        } else {
                            blurMask.classList.remove('active');
                            console.error('No schedules returned:', data);
                        }
                    }).catch(error => {
                        blurMask.classList.remove('active');
                        alert("Aucun horaire n'a été trouvé!")
                        clearCalendar()
                        console.error('Error fetching schedules:', error);
                    });
                };
                listItem.appendChild(removeButton);
                classList.appendChild(listItem);
            });
        }

        function updateScheduleDisplay() {
            document.getElementById('scheduleIndex').textContent = `${window.currentScheduleIndex + 1}/${window.schedules.length}`;
        }

        function fetchAndDisplaySchedule(index) {
            const schedule = window.schedules[index];
            return Promise.all(schedule.map(className => fetch(`/class_details?class_name=${className}`).then(res => res.json()).then(res => res.class_details))).then(classDetailsArray => {
                displaySchedule(classDetailsArray.flat());
            }).catch(error => {
                console.error('Error fetching class details:', error);
            });
        }

        function displaySchedule(classes) {
            const calendarTableBody = document.querySelector('#calendarTable tbody');
            calendarTableBody.innerHTML = '';
            const startHour = 9;
            const endHour = 22;
            const rows = (endHour - startHour) * 2; // Two rows per hour
            const columns = 6; // Time + 5 weekdays

            for (let i = 0; i < rows; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < columns; j++) {
                    const cell = document.createElement('td');
                    if (j === 0) { // Time column
                        const hour = Math.floor(i / 2) + startHour;
                        const minute = i % 2 === 0 ? '00' : '30';
                        cell.textContent = `${hour.toString().padStart(2, '0')}:${minute}`;
                    }
                    row.appendChild(cell);
                }
                calendarTableBody.appendChild(row);
            }

            classes.forEach(classDetail => {
                const dayIndex = {
                    'Lundi': 1,
                    'Mardi': 2,
                    'Mercredi': 3,
                    'Jeudi': 4,
                    'Vendredi': 5
                } [classDetail.day];
                const className = classDetail.name.split('-')[0];
                const startTime = parseInt(classDetail.start_time.split('h')[0]);
                const endTime = parseInt(classDetail.end_time.split('h')[0]);
                const startMinute = parseInt(classDetail.start_time.split('h')[1] || "00");
                const endMinute = parseInt(classDetail.end_time.split('h')[1] || "00");
                let startRow = (startTime - startHour) * 2;
                if (startMinute >= 30) startRow++;
                let endRow = (endTime - startHour) * 2;
                if (endMinute > 0) endRow++;
                const classColor = getClassColor(className, classDetail.type);
                for (let row = startRow; row < endRow; row++) {
                    if (calendarTableBody.children[row]) {
                        const cell = calendarTableBody.children[row].children[dayIndex];
                        cell.textContent = `${className} - Groupe ${classDetail.group}`;
                        cell.title = `Cours: ${className}\nEnseignant: ${classDetail.teacher}\nJour: ${classDetail.day}\nHeure: ${classDetail.start_time} - ${classDetail.end_time}\nGroupe: ${classDetail.group}\nLocal: ${classDetail.location}\nType: ${classDetail.type}\nDates: ${classDetail.dates}`;
                        cell.classList.add('class-info');
                        cell.style.backgroundColor = classColor;
                    }
                }
            });
        }

        function getClassColor(className, classType) {
            if (!window.classColors) {
                window.classColors = {};
            }
            if (!window.classColors[className]) {
                let color = '#' + (Math.floor(Math.random() * 127 + 128).toString(16).padStart(2, '0')) + (Math.floor(Math.random() * 127 + 128).toString(16).padStart(2, '0')) + (Math.floor(Math.random() * 127 + 128).toString(16).padStart(2, '0'));
                window.classColors[className] = color;
            }
            let rgb = hexToRgb(window.classColors[className]);
            if (classType === 'Cours magistral') {
                rgb = adjustColorBrightness(rgb, 0);
            } else if (classType === 'Atelier') {
                rgb = adjustColorBrightness(rgb, 10);
            }
            return rgbToHex(rgb);
        }

        function hexToRgb(hex) {
            let bigint = parseInt(hex.slice(1), 16);
            let r = (bigint >> 16) & 255;
            let g = (bigint >> 8) & 255;
            let b = bigint & 255;
            return {
                r,
                g,
                b
            };
        }

        function rgbToHex(rgb) {
            return `#${((1 << 24) + (rgb.r << 16) + (rgb.g << 8) + rgb.b).toString(16).slice(1)}`;
        }

        function adjustColorBrightness(rgb, percent) {
            let r = Math.round(rgb.r * (1 + percent / 100));
            let g = Math.round(rgb.g * (1 + percent / 100));
            let b = Math.round(rgb.b * (1 + percent / 100));
            r = Math.min(255, Math.max(0, r));
            g = Math.min(255, Math.max(0, g));
            b = Math.min(255, Math.max(0, b));
            return {
                r,
                g,
                b
                 };
                }
            });
</script>
    </body>
</html>